create or replace 
PROCEDURE KMB_FETCH_OCR_PDF_DETAILS(
    v_OwnerID NUMBER,
    cv_1 OUT SYS_REFCURSOR )
AS
  V_JOBID        NUMBER(10, 0);
  V_TASKID       NUMBER(10, 0);
  V_BATCHNUMBER  NUMBER(10, 0);
  V_CURRENTDATE  DATE;
  V_SUCCESSCOUNT NUMBER(10, 0):=0;
BEGIN

------------ Fetch Job Id of this Job -----------
SELECT Jobid
INTO   V_JOBID
FROM   CIS_Job
WHERE  OWNERID = V_OWNERID
       AND JOBNAME = 'C-KYC data push to BCIF and CERSAI';

------------ Fetch Task Id of this Task -----------
SELECT TaskID
INTO   V_TASKID
FROM   CIS_TASK
WHERE  OwnerID = v_OwnerID
       AND JOBID = V_JOBID
       AND TASKNAME = 'Fetch OCR Generated PDF details';


------------ Fetch Current Batch Number -----------
V_BATCHNUMBER := CIS_GET_BATCH_NUMBER(V_OWNERID, V_JOBID);

 Select   count(max(A.Attachedid)) into V_SUCCESSCOUNT
  FROM DMSMASTER d
  INNER JOIN ATTACHMENTMASTER a
  ON d.OWNERID   = a.OWNERID
  AND d.ITEMID   = a.Attachedid
  AND a.ITEMTYPE = 6
  INNER JOIN KMB_CKYC_OCR_LT LT
  ON lT.LEADID = a.ITEMID
  INNER JOIN lea_ex1 l1
  ON l1.lea_ex1_id =lt.leadid
  Where D.Ownerid  =v_OwnerID
  AND upper(d.itemname) LIKE '%PDF_OCRIMAGE_%'
  --OR  upper(d.itemname) LIKE '%%'
  Group By Lt.Leadid,
    L1.Lea_Ex1_2;

    If(V_Successcount>=1)Then
    BEGIN

  Open Cv_1 For
  SELECT SourceFileName,TargetFileName FROM
  (

  SELECT '\\10.10.5.138\uploadroot\Store641\' || MAX(A.ATTACHEDID)  || '_1' AS SOURCEFILENAME,
'\\10.10.5.138\Uploadroot\CA\CKYC\Address_Proof_Customer_Photo\'||NVL(L1.LEA_EX1_2,LT.LEADID)||'_'||LT.EXTENSION||'.pdf' AS TargetFileName
  FROM DMSMASTER d
  INNER JOIN ATTACHMENTMASTER a
  ON d.OWNERID   = a.OWNERID
  AND d.ITEMID   = a.Attachedid
  AND a.ITEMTYPE = 6
  INNER JOIN KMB_CKYC_OCR_LT LT
  ON LT.LEADID = A.ITEMID
  INNER JOIN lea_ex1 l1
  ON l1.lea_ex1_id =lt.leadid
  Where D.Ownerid  =v_OwnerID
  AND upper(d.itemname) LIKE '%PDF_OCRIMAGE_%'

  Group By Lt.Leadid, l1.lea_ex1_2,LT.EXTENSION)

  -- Union All
  -- (
   -- SELECT '\\PERFSTER\UploadRoot\Store641\' ||  MAX(A.ATTACHEDID) || '_1' AS SOURCEFILENAME,
-- '\\Perfster\kmb_ca\OCR_PDF\'|| NVL(L1.LEA_EX1_2,LT.LEADID)||'_PAN.PDF' AS TargetFileName
-- FROM DMSMASTER d
-- INNER JOIN ATTACHMENTMASTER a
-- ON d.OWNERID   = a.OWNERID
-- AND d.ITEMID   = a.Attachedid
-- AND a.ITEMTYPE = 6
 -- INNER JOIN KMB_CKYC_OCR_LT LT
  -- ON LT.LEADID = A.ITEMID
  -- INNER JOIN lea_ex1 l1
  -- ON l1.lea_ex1_id =lt.leadid
  -- Where D.Ownerid  =v_OwnerID
  -- AND upper(d.itemname) LIKE '%CA_PAN_Image%'

  -- Group By Lt.Leadid, l1.lea_ex1_2)

Union All
(
      SELECT '\\10.10.5.138\UploadRoot\Store641\' ||  MAX(A.ATTACHEDID) || '_1' AS SOURCEFILENAME,
'\\10.10.5.138\Uploadroot\CA\CKYC\Address_Proof_Customer_Photo\'  || NVL(L1.LEA_EX1_2,LT.LEADID)  ||'_PHOTO.PDF' AS TargetFileName
FROM DMSMASTER d
INNER JOIN ATTACHMENTMASTER a
ON d.OWNERID   = a.OWNERID
AND d.ITEMID   = a.Attachedid
AND a.ITEMTYPE = 6
INNER JOIN KMB_CKYC_OCR_LT LT
  ON LT.LEADID = A.ITEMID
  INNER JOIN lea_ex1 l1
  ON l1.lea_ex1_id =lt.leadid
  Where D.Ownerid  =v_OwnerID
  AND upper(d.itemname) LIKE '%CA_Customer_Photo%'

  Group By Lt.Leadid, l1.lea_ex1_2
)  ;


End;
End if;
---------------------- Update count of updated records in CIS_Log table for ease of visibility on UI --------------------
UPDATE Cis_Log
SET successcount = V_SUCCESSCOUNT
WHERE ownerid    = V_OWNERID
AND BATCHNUMBER  = V_BATCHNUMBER
AND SOURCEID     = V_TASKID;


END;