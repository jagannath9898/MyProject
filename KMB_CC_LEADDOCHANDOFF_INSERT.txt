create or replace 
PROCEDURE KMB_CC_LEADDOCHANDOFF_INSERT (V_OWNERID IN NUMBER,
                                        CV_1 OUT SYS_REFCURSOR)
AS
    V_JOBID NUMBER;
    V_TASKID NUMBER;
    V_BATCHNUMBER NUMBER;
    V_SUCCESSCOUNT NUMBER := 0;
  
BEGIN
/*
  SUMMARY : THIS TASK WILL INSERT ETB PDF AND NTB PDF + DOCUMENT RELATED DATA INTO LANDING TABLE BASIS CONDITIONS MENTIONED BELOW. 
            THIS TASK WILL PROVIDE SOURCE AND TARGET PATH FOR FILE TO BE MOVED.
  CREATED BY : YASH PIMPALE
  CREATED ON : 11-03-2021
*/
    
  EXECUTE IMMEDIATE 'ALTER SESSION SET NLS_SORT = ''BINARY_CI''';
  EXECUTE IMMEDIATE 'ALTER SESSION SET NLS_COMP = ''LINGUISTIC''';
  EXECUTE IMMEDIATE 'ALTER SESSION SET NLS_DATE_FORMAT = ''DD-MM-YYYY HH24:MI:SS''';
  
  ----- GET JOBID OF JOB -----
 
  SELECT JOBID INTO V_JOBID 
  FROM CIS_JOB 
  WHERE OWNERID = V_OWNERID
  AND JOBNAME = 'Export Credit Card Lead Document to LOS';
  
  ----- GET TASKID OF JOB -----
 
  SELECT TASKID INTO V_TASKID 
  FROM CIS_TASK
  WHERE OWNERID = V_OWNERID
  AND JOBID = V_JOBID
  AND TASKNAME = 'Insert Document Data into LT';
 
  ----- GET CURRENT BATCHNUMBER -----
 
  V_BATCHNUMBER := CIS_GET_BATCH_NUMBER(V_OWNERID, V_JOBID);
  
  ----- INSERT ETB APPLICATION PDF RELATED DATA INTO LANDING TABLE -----
  
  INSERT INTO KMB_CC_LEADDOCHANDOFF_LT
  (
    LEADID,
    ARN,
    ATTACHEDID,
    DOCUMENTNAME,
    ETB_NTB_IDENTIFIER,
    PDF_FLAG,
    SYNCFLAG
  )
  SELECT A.ITEMID AS LEADID,
         LE6.LEA_EX6_161 AS ARN,
         D.ITEMID AS ATTACHEDID,
         D.ITEMNAME AS DOCUMENTNAME,
         'ETB' AS ETB_NTB_IDENTIFIER,
         1 AS PDF_FLAG,
         0 AS SYNCFLAG
  FROM DMSMASTER D
  INNER JOIN DMS_EX1 DE1
  ON D.OWNERID = DE1.OWNERID
  AND D.ITEMID = DE1.DMS_EX1_ID
  INNER JOIN ATTACHMENTMASTER A
  ON D.OWNERID = A.OWNERID
  AND D.ITEMID = A.ATTACHEDID
  INNER JOIN LEADS L
  ON A.OWNERID = L.OWNERID
  AND A.ITEMID = L.LEADID
  AND A.ITEMTYPE = 6
  INNER JOIN LEA_EX1 LE1
  ON L.OWNERID = LE1.OWNERID
  AND L.LEADID = LE1.LEA_EX1_ID
  INNER JOIN LEA_EX6 LE6
  ON L.OWNERID = LE6.OWNERID
  AND L.LEADID = LE6.LEA_EX6_ID
  WHERE L.OWNERID = V_OWNERID
  AND L.LAYOUTID = 112277          -- CC ENHANCEMENT
  AND L.STATUSCODEID = 100041      -- SENT TO LOS
  AND LE1.LEA_EX1_17 = 1           -- PDF GENERATE FLAG SHOULD BE "1"
  AND LE6.LEA_EX6_81 = 'ETB'       -- CUSTOMER TYPE SHOULD BE "ETB"
  AND DE1.DMS_EX1_1 = 'N'          -- DMS SYNC FLAG SHOULD BE "N" (NOT SYNCED)
  AND D.CONTENTTYPE = 'application/pdf' -- CONTENT TYPE SHOULD BE "APPICATION\PDF"
  AND D.ITEMNAME LIKE 'CC_Application_PDF%';  -- DOCUMENT NAME SHOULD START WITH "CC_APPLICATION_PDF"
  
  ----- GET COUNT OF RECORDS INSERTED INTO LANDING TABLE -----
  V_SUCCESSCOUNT := SQL%ROWCOUNT;
  
  ----- INSERT NTB APPLICATION PDF RELATED DATA INTO LANDING TABLE -----
  
  INSERT INTO KMB_CC_LEADDOCHANDOFF_LT
  (
    LEADID,
    ARN,
    ATTACHEDID,
    DOCUMENTNAME,
    ETB_NTB_IDENTIFIER,
    PDF_FLAG,
    SYNCFLAG
  )
  SELECT A.ITEMID AS LEADID,
         LE6.LEA_EX6_161 AS ARN,
         D.ITEMID AS ATTACHEDID,
         D.ITEMNAME AS DOCUMENTNAME,
         'NTB' AS ETB_NTB_IDENTIFIER,
         1 AS PDF_FLAG,
         0 AS SYNCFLAG
  FROM DMSMASTER D
  INNER JOIN DMS_EX1 DE1
  ON D.OWNERID = DE1.OWNERID
  AND D.ITEMID = DE1.DMS_EX1_ID
  INNER JOIN ATTACHMENTMASTER A
  ON D.OWNERID = A.OWNERID
  AND D.ITEMID = A.ATTACHEDID
  INNER JOIN LEADS L
  ON A.OWNERID = L.OWNERID
  AND A.ITEMID = L.LEADID
  AND A.ITEMTYPE = 6
  INNER JOIN LEA_EX1 LE1
  ON L.OWNERID = LE1.OWNERID
  AND L.LEADID = LE1.LEA_EX1_ID
  INNER JOIN LEA_EX6 LE6
  ON L.OWNERID = LE6.OWNERID
  AND L.LEADID = LE6.LEA_EX6_ID
  WHERE L.OWNERID = V_OWNERID
  AND L.LAYOUTID = 112277          -- CC ENHANCEMENT
  AND L.STATUSCODEID = 100041      -- SENT TO LOS
  AND LE1.LEA_EX1_17 = 1           -- PDF GENERATE FLAG SHOULD BE "1"
  AND LE6.LEA_EX6_81 = 'NTB'       -- CUSTOMER TYPE SHOULD BE "NTB"
  AND DE1.DMS_EX1_1 = 'N'          -- DMS SYNC FLAG SHOULD BE "N" (NOT SYNCED)
  AND D.CONTENTTYPE = 'application/pdf' -- CONTENT TYPE SHOULD BE "APPICATION\PDF"
  AND D.ITEMNAME LIKE 'CC_Application_PDF%';  -- DOCUMENT NAME SHOULD START WITH "CC_APPLICATION_PDF"
  
  ----- GET COUNT OF RECORDS INSERTED INTO LANDING TABLE -----
  V_SUCCESSCOUNT := V_SUCCESSCOUNT + SQL%ROWCOUNT;
  
  ----- INSERT NTB DOCUMENT RELATED DATA INTO LANDING TABLE -----
  
  INSERT INTO KMB_CC_LEADDOCHANDOFF_LT
  (
    LEADID,
    ARN,
    ATTACHEDID,
    DOCUMENTNAME,
    ETB_NTB_IDENTIFIER,
    PDF_FLAG,
    SYNCFLAG
  )
  SELECT A.ITEMID AS LEADID,
         LE6.LEA_EX6_161 AS ARN,
         D.ITEMID AS ATTACHEDID,
         D.ITEMNAME AS DOCUMENTNAME,
         'NTB' AS ETB_NTB_IDENTIFIER,
         0 AS PDF_FLAG,
         0 AS SYNCFLAG
  FROM DMSMASTER D
  INNER JOIN DMS_EX1 DE1
  ON D.OWNERID = DE1.OWNERID
  AND D.ITEMID = DE1.DMS_EX1_ID
  INNER JOIN ATTACHMENTMASTER A
  ON D.OWNERID = A.OWNERID
  AND D.ITEMID = A.ATTACHEDID
  INNER JOIN LEADS L
  ON A.OWNERID = L.OWNERID
  AND A.ITEMID = L.LEADID
  AND A.ITEMTYPE = 6
  INNER JOIN LEA_EX1 LE1
  ON L.OWNERID = LE1.OWNERID
  AND L.LEADID = LE1.LEA_EX1_ID
  INNER JOIN LEA_EX6 LE6
  ON L.OWNERID = LE6.OWNERID
  AND L.LEADID = LE6.LEA_EX6_ID
  WHERE L.OWNERID = V_OWNERID
  AND L.LAYOUTID = 112277          -- CC ENHANCEMENT
  AND L.STATUSCODEID = 100041      -- SENT TO LOS
  AND LE6.LEA_EX6_81 = 'NTB'       -- CUSTOMER TYPE SHOULD BE "NTB"
  AND DE1.DMS_EX1_1 = 'N'          -- DMS SYNC FLAG SHOULD BE "N" (NOT SYNCED)
  AND D.ITEMNAME NOT LIKE 'CC_Application_PDF%';  -- DOCUMENT NAME SHOULD START WITH "CC_APPLICATION_PDF"
  
  ----- GET COUNT OF RECORDS INSERTED INTO LANDING TABLE -----
  V_SUCCESSCOUNT := V_SUCCESSCOUNT + SQL%ROWCOUNT;
  
  ---- UPDATE RECORD COUNT IN CIS_LOG FOR EASY VISIBILITY ON UI ----
    
  UPDATE CIS_LOG
  SET SUCCESSCOUNT = V_SUCCESSCOUNT
  WHERE OWNERID = V_OWNERID
   AND BATCHNUMBER = V_BATCHNUMBER
   AND SOURCEID = V_TASKID
   AND SOURCETYPEID = 3;

  ----- PROVIDE SOURCE AND TARGET PATH AS OUTPUT -----

  OPEN CV_1 FOR
  
  ----- PROVIDE SOURCE AND TARGET PATH FOR ETB DOCUMENTS -----
  
  SELECT 	'\\10.10.5.138\uploadroot\Store641\' || ATTACHEDID || '_1' AS SourcePath,
          '\\10.10.5.138\Uploadroot\KMB_LEAD_HANDOFF_LOS\KMB_CC_LEADDOC_HANDOFF\ETB_INTERMEDIATE\' || ARN  || '.pdf' AS TargetPath
	FROM KMB_CC_LEADDOCHANDOFF_LT 
	WHERE ERRORCODE = 0
	AND ETB_NTB_IDENTIFIER = 'ETB'
	AND PDF_FLAG = 1
	AND SYNCFLAG = 0
	
	UNION ALL
	
	SELECT 	'\\10.10.5.138\uploadroot\Store641\' || ATTACHEDID || '_1' AS SourcePath,
          '\\10.10.5.138\Uploadroot\KMB_LEAD_HANDOFF_LOS\KMB_CC_LEADDOC_HANDOFF\NTB_INTERMEDIATE\' || ARN  || '.pdf' AS TargetPath
	FROM KMB_CC_LEADDOCHANDOFF_LT 
	WHERE ERRORCODE = 0
	AND ETB_NTB_IDENTIFIER = 'NTB'
	AND PDF_FLAG = 1
	AND SYNCFLAG = 0
  
  UNION ALL
	
	SELECT 	'\\10.10.5.138\uploadroot\Store641\' || ATTACHEDID || '_1' AS SourcePath,
          '\\10.10.5.138\Uploadroot\KMB_LEAD_HANDOFF_LOS\KMB_CC_LEADDOC_HANDOFF\NTB_INTERMEDIATE\' || ARN || '_' || DOCUMENTNAME AS TargetPath
	FROM KMB_CC_LEADDOCHANDOFF_LT 
	WHERE ERRORCODE = 0
	AND ETB_NTB_IDENTIFIER = 'NTB'
	AND PDF_FLAG = 0
	AND SYNCFLAG = 0;

END;