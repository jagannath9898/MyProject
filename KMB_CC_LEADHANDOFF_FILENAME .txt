create or replace 
PROCEDURE KMB_CC_LEADHANDOFF_FILENAME (V_OWNERID NUMBER,
                                          CV_1 OUT SYS_REFCURSOR)
                                                          
AS 
    V_CURRENTDATE DATE;
	V_JOBID NUMBER(10);
	V_TASKID NUMBER(10);
	V_BATCHNUMBER NUMBER(10);
    V_SEQUENCENO NUMBER(2);
    V_NEWSEQUENCENO NUMBER(2);
    V_JULIANDATE NUMBER(10);
    V_TEMPDATE NUMBER(10);
BEGIN
/*
	SUMMARY : ONCE CSV FILE (PREEMB + DDMMYY FOR E.G. PREEMB230321.CSV) IS GENERATED ON SERVER, THIS SP WILL PROVIDE SOURCE AND TARGET PATH FOR CSV FILE TO BE MOVED TO ANOTHER LOCATION. IN ADDITION TO MOVING, THIS TASK WILL GENERATE NEW SEQUENCE NUMBER (RESET TO 1 EVERY DAY) WHICH WILL BE APPENDED TO CSV FILE NAME. ACTUAL FILE NAME REQUIRED (PREEMB + DDMMYY + SEQUENCE NUMBER FOR E.G. PREEMB23032101.CSV)
	CREATED BY : YASH PIMPALE
	CREATED ON : 17-02-2021
	
	MODIFIED BY : YASH PIMPALE
	MODIFIED ON : 30-04-2021
	MODIFICATIONS : CHANGED CSV FILE NAME FROM "PREEMB" TO "PREEMBUPLDB".
*/

EXECUTE IMMEDIATE 'ALTER SESSION SET NLS_SORT = ''BINARY_CI''';
EXECUTE IMMEDIATE 'ALTER SESSION SET NLS_COMP = ''LINGUISTIC''';
EXECUTE IMMEDIATE 'ALTER SESSION SET NLS_DATE_FORMAT=''DDMMYY''';

  ----- GET JOBID OF JOB -----
 
 SELECT JOBID INTO V_JOBID 
 FROM CIS_JOB 
 WHERE OWNERID = V_OWNERID
 AND JOBNAME = 'Export Credit Card Lead Data to LOS';
  
 ----- GET TASKID OF JOB -----
 
 SELECT TASKID INTO V_TASKID 
 FROM CIS_TASK
 WHERE OWNERID = V_OWNERID
 AND JOBID = V_JOBID
 AND TASKNAME = 'Generate CSV File Name';
 
 ----- GET CURRENT BATCHNUMBER -----
 
 V_BATCHNUMBER := CIS_GET_BATCH_NUMBER(V_OWNERID, V_JOBID);
  
  ---- GET CURRENT DATE ----

  V_CURRENTDATE := GETDATE();
  
  ---- GET TODAY'S JULIAN DATE (Ex: 1st JAN = 001, 31st DEC=365 AND FOR LEAP YEAR 31st- DEC=366) ----

  SELECT TO_CHAR(CURRENT_DATE, 'DDD')
  INTO V_JULIANDATE
  FROM DUAL;
  
  ---- GET SEQUENCE NUMBER AND DATE FROM TEMPERARY TABLE ----  

  SELECT SEQUENCENO,
         CURRENTDATE
  INTO V_SEQUENCENO,
       V_TEMPDATE
  FROM KMB_CC_LEADDATAHANDOFF_TEMP;
  
  ---- CHECK IF CURRENT JULIAN DATE IS EQUAL TO DATE STORED IN TEMP TABLE ----

  IF(V_JULIANDATE = V_TEMPDATE) THEN
    BEGIN
      
      ---- IF YES, THEN INCEREASE SEQUENCE NUMBER BY 1 ----
      UPDATE KMB_CC_LEADDATAHANDOFF_TEMP
      SET SEQUENCENO = (V_SEQUENCENO + 1); 
      
    END;
    
  ELSE
    BEGIN
      ---- IF NO, i.e. IT IS NEXT DAY, THEN RESET SEQUENCE NUMBER ----
      UPDATE KMB_CC_LEADDATAHANDOFF_TEMP
      SET CURRENTDATE   = V_JULIANDATE,
          SEQUENCENO    = 1;     
          
    END;
  END IF;
   
  ---- GET LATEST SEQUNCE NUMBER FROM TEMP TABLE ---- 
  SELECT SEQUENCENO INTO V_NEWSEQUENCENO FROM KMB_CC_LEADDATAHANDOFF_TEMP;
  
  ---- UPDATE COUNT IN CIS_LOG TABLE FOR EASE OF VISIBILITY ON UI ----
  
  UPDATE CIS_LOG
  SET SUCCESSCOUNT = 1
  WHERE  OWNERID = V_OWNERID
     AND BATCHNUMBER = V_BATCHNUMBER
     AND SOURCEID = V_TASKID
     AND SOURCETYPEID = 3;

  OPEN CV_1 FOR
  
  SELECT '\\10.10.5.138\Uploadroot\KMB_LEAD_HANDOFF_LOS\KMB_CC_LEADDATA_HANDOFF\PREEMBUPLDB' || V_CURRENTDATE || '.csv' AS SourcePath,
         '\\10.10.5.138\Uploadroot\KMB_LEAD_HANDOFF_LOS\KMB_CC_LEADDATA_HANDOFF_TARGET\PREEMBUPLDB' || V_CURRENTDATE || LPAD(V_NEWSEQUENCENO,2,'0') ||'.csv' AS TargetPath,
		 '\\10.10.5.138\Uploadroot\KMB_LEAD_HANDOFF_LOS\KMB_CC_LEADDATA_HANDOFF_SECLOC\PREEMBUPLDB' || V_CURRENTDATE || LPAD(V_NEWSEQUENCENO,2,'0') ||'.csv' AS SecondaryPath
  FROM DUAL;
  
END;